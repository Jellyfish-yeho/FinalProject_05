<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cafe">
   <sql id="searchCondition">
      <choose>
         <when test="title != null and content != null">
            WHERE title LIKE '%'||#{title}||'%' 
            OR content LIKE '%'||#{content}||'%'
         </when>
         <when test="title != null">
            WHERE title LIKE '%'||#{title}||'%'
         </when>
         <when test="writer != null">
            WHERE writer LIKE '%'||#{writer}||'%'
         </when>
      </choose>
   </sql>
   
	<insert id="likeInsert" parameterType="likeDto">
		INSERT INTO liketo
		(cafe_num, liked_user)
		VALUES(#{cafe_num}, #{liked_user})
	</insert>
	
	<delete id="likeDelete" parameterType="likeDto">
		DELETE FROM likedto
		WHERE cafe_num=#{cafe_num}, liked_user=#{liked_user}
	</delete>
	
	<update id="minusViewCount" parameterType="int">
		UPDATE board_cafe
		SET viewCount=viewCount-1
		 WHERE num=#{num}
	</update>
   
	<select id="isLiked" parameterType="likeDto">
		SELECT cafe_num, liked_user
		FROM liketo
		WHERE cafe_num=#{cafe_num}, liked_user=#{liked_user}
	</select>

   <select id="getList" parameterType="cafeDto" resultType="cafeDto">
      SELECT *
      FROM
         (SELECT result1.*, ROWNUM AS rnum
         FROM
            (SELECT num,writer,title,content,category,viewCount,reply_count,
            likecount,to_char(board_cafe.regdate,'yyyy-mm-dd HH24:MI') as regdate,profile
            FROM board_cafe
            INNER JOIN users
            ON board_cafe.writer=users.id
            <include refid="searchCondition"/>
            ORDER BY num DESC) result1)
      <![CDATA[ 
      WHERE rnum >= #{startRowNum} AND rnum <= #{endRowNum}
      ]]>
   </select>
   
   <select id="getCount" parameterType="cafeDto" resultType="int">
      SELECT NVL(MAX(ROWNUM), 0)
      FROM board_cafe
      <include refid="searchCondition"/>
   </select>   
   
   <insert id="insert" parameterType="cafeDto">
      INSERT INTO board_cafe
      (num,writer,title,category,content,viewCount,reply_count,likeCount,regdate)
      VALUES(board_cafe_seq.NEXTVAL, #{writer}, #{title}, #{category},
         #{content}, #{viewCount}, 0, 0, SYSDATE)
   </insert>
   
   <select id="getData" parameterType="int" resultType="cafeDto">
      SELECT result1.*
      FROM
         (SELECT num,writer,title,category,content,
         	reply_count,viewCount,likeCount,
            TO_CHAR(board_cafe.regdate,'YY.MM.DD HH24:MI') AS regdate,profile,
            LAG(num,1,0) OVER (ORDER BY num DESC) AS prevNum,
            LEAD(num,1,0) OVER (ORDER BY num DESC) AS nextNum
         FROM board_cafe
         INNER JOIN users
         ON board_cafe.writer=users.id
         ) result1
      WHERE num=#{num}
         
   </select>
   
   <select id="getData2" parameterType="cafeDto" resultType="cafeDto">
      SELECT result1.*
      FROM
         (SELECT num,writer,title,category,
         	content,reply_count,viewCount,likeCount,
            TO_CHAR(board_cafe.regdate,'YY.MM.DD HH24:MI') AS regdate,profile,
            LAG(num,1,0) OVER (ORDER BY num DESC) AS prevNum,
            LEAD(num,1,0) OVER (ORDER BY num DESC) AS nextNum
         FROM board_cafe
         INNER JOIN users
         ON board_cafe.writer=users.id
         <include refid="searchCondition"/>
         ) result1
      WHERE num=#{num}   
   </select>
   
   <update id="addViewCount" parameterType="int">
      UPDATE board_cafe
      SET viewCount=viewCount+1
      WHERE num=#{num}
   </update>
   
   <delete id="delete" parameterType="int">
      DELETE FROM board_cafe
      WHERE num=#{num}
   </delete>
   
   <update id="update" parameterType="cafeDto">
      UPDATE board_cafe
      SET title=#{title}, content=#{content}
      WHERE num=#{num}
   </update>
   

	<update id="updateReplyCount" parameterType="int">
		UPDATE board_cafe b
		SET b.reply_count 
		= (SELECT count(num) 
			FROM board_cafe_comment
			WHERE ref_group=#{num})
		WHERE b.num=#{num}
	</update>


</mapper>







